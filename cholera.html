<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style> /* set the CSS */

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 60px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightgray;
        border: 0px;
        border-radius: 2px;
        pointer-events: none;
    }
    .axis text {
        font-family: sans-serif;
        font-size: 8px;
    }
    .arc text {
        font-family: sans-serif;
        font-size: 12px;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .yaxis text {
        font-family: sans-serif;
        font-size: 8px;
    }

    .yaxis path,
    .yaxis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .container {
        float: left;
    }

    p {
        text-align:center;
        font-family: sans-serif;
        font-size: 18px;
        border-bottom: 3px double;
    }


    #donutTitle {
        text-align:center;
        font-family: sans-serif;
        font-size: 16px;
        position: absolute;
    }
    #content {
        position: relative;
    }
    #content img {
        position: absolute;
        top: -15px;
        right: 0px;
    }

    #about {
        position: absolute;
        top: -15px;
        right: 0px;
        font-family: sans-serif;
        font-size: 12px;
    }

    #radiobutton {
        font-family: sans-serif;
        font-size: 12px;
        z-index: 400;
    }

    #clusters {
        font-family: sans-serif;
        font-size: 12px;
        z-index: 400;
    }

    </style>
    <title>Trevor Toll's Project 1: H517 Visualization Design, Analysis,
        & Evaluation</title>



    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

</head>

<body>

<div id="donutTitle">
    <div>Deaths by Gender</div>
</div>

<div id="content">
    <img src="iu_logo.png" class="ribbon" width="25"/>
    <div><p> Trevor Toll's Project 1 for H517 Visualization Design, Analysis,
        & Evaluation</p></div>
</div>
<div id="radiobutton">
    <form id="dimensions">
        Color Map by <br>
        <input type='radio' id="Gender" name="mode" checked>Gender</input><br>
        <input type='radio' id="Age" name="mode" >Age</input><br>
        <input type='radio' id="Cluster" name="mode" >Clusters</input><br>
    </form>
</div>

<div id="clusters">
    <form id="clustering">
        # of Clusters <br>
        <input type='radio' id="1" name="clstr" >1</input><br>
        <input type='radio' id="2" name="clstr" >2</input><br>
        <input type='radio' id="3" name="clstr" checked>3</input><br>
        <input type='radio' id="4" name="clstr" >4</input><br>
        <input type='radio' id="5" name="clstr" >5</input><br>
        <input type='radio' id="6" name="clstr" >6</input><br>
        <input type='radio' id="7" name="clstr" >7</input><br>
    </form>
</div>


<div class="container" id="area1">
</div>
<div class="container" id="area2">
</div>
<div class="container" id="area3">
</div>
<div class="container" id="area4">
</div>
<div class="container" id="area5">
</div>

<div id="about">
    <a href="about.html">About</a>
</div>







<script type="text/javascript">

    d3.select('input[name="mode"]:checked').property("id");
    var formatPercent = d3.format(".0%");

    var d = document.getElementById('donutTitle');
    d.style.position = "absolute";
    d.style.left = 630+'px';
    d.style.top = 300+'px';

    var d = document.getElementById('radiobutton');
    d.style.position = "absolute";
    d.style.left = 505+'px';
    d.style.top = 320+'px';

    var d = document.getElementById('clusters');
    d.style.position = "absolute";
    d.style.left = 505+'px';
    d.style.top = 400+'px';

    var d = document.getElementById('area2');
    d.style.position = "absolute";
    d.style.left = 500+'px';
    d.style.top = 50+'px';

    var d = document.getElementById('area3');
    d.style.position = "absolute";
    d.style.left = 495+'px';
    d.style.top = 320+'px';

    var d = document.getElementById('area4');
    d.style.position = "absolute";
    d.style.left = 850+'px';
    d.style.top = 300+'px';

    var d = document.getElementById('area5');
    d.style.position = "absolute";
    d.style.left = 25+'px';
    d.style.top = 45+'px';

    var d = document.getElementById('about');
    d.style.position = "absolute";
    d.style.left = 1290+'px';
    d.style.top = 15+'px';

    var Important2 = 99999;
    //Map height/width
    var hMap = 500;
    var wMap = 500;
    var mapScale = 30;
    var margin = {top: 25, right: 0, bottom: 40, left: 15};

    var svgContainer = d3.select("#area1").append("svg")
        .attr("width", wMap)
        .attr("height", hMap+margin.top)
        .call(d3.behavior.zoom().on("zoom", function () {
            svgContainer.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
        }))
        .append('g');

    var svgMapLegend = d3.select("#area5").append("svg")
        .attr("width", wMap)
        .attr("height", 50)
        .append('g');

    //Bar chart height/width
    var hBar = 225 - margin.bottom;
    var wBar = 750 - 20;
    var svgBar = d3.select("#area2").append("svg")
        .attr("width", wBar + margin.left + margin.right)
        .attr("height", hBar + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
    //Donut scale/height/width
    var donutScale = 3;
    var wDonut = (960*1.2/donutScale),
        hDonut = (600*1.3/donutScale),
        radius = Math.min(wDonut, hDonut) / 2.25;
    var svgDonut = d3.select("#area3").append("svg")
        .attr("width", (wDonut))
        .attr("height", (hDonut))
        .append("g")
        .attr("transform", "translate(" + wDonut / 2 + "," + hDonut / 2 + ")");

    //Scatter svg
    var ScatterWidth = 450;
    var ScatterHeight = 300;

    var svgScatterPlot = d3.select("#area4").append("svg")
        .attr("width", ScatterWidth)
        .attr("height", ScatterHeight);

    function drawMapLegend() {
        d3.csv("legend.csv", function(mapLegend){

            svgMapLegend.selectAll("legends")
                .data(mapLegend)
                .enter()
                .append("circle")
                .attr("cx", function(d,i) {
                    return (d.a* 140)
                        ;
                })
                .attr("cy", 15)
                .attr("r", 6)
                .attr("fill",  function(d,i) {
                    if (d.a == 3 ) { return "#415ec5" }
                    if (d.a == 2 ) { return "#c57a1a" }
                    else { return "black" }
                    ;
                });

            svgMapLegend.selectAll("legends")
                .data(mapLegend)
                .enter()
                .append("text")
                .attr("x", function(d,i) {
                    return (d.a* 140)-85
                        ;
                })
                .attr("y", 18)
                .style("font-size", "12px")
                .style("fill","black")
                .style("font-family", "sans-serif")
                .text(function (d) {
                    return d.b
                });

            svgMapLegend.selectAll("legends")
                .data(mapLegend)
                .enter()
                .append("text")
                .attr("x", 137)
                .attr("y", 19)
                .style("font-size", "11px")
                .style("fill","white")
                .text("P");



        });
    }



    //Map
    d3.json("streets.json", function(streetMap){



        var yScale= d3.max(d3.values(streetMap), function(d) {return d[0].y*mapScale,d[1].y*mapScale;});
        var xMargin = d3.min(d3.values(streetMap), function(d) {return d[0].x*mapScale,d[1].x*mapScale;});

        var i;
        for (i of streetMap) {
            //This is the accessor function we talked about above
            var lineFunction = d3.svg.line()
                .x(function(d) { return d.x*mapScale-xMargin;})
                .y(function(d) { return yScale - d.y*mapScale+margin.top;})
                .interpolate("basis");

            var lineGraph = svgContainer.append("path")
                .attr("d", lineFunction(i))
                .attr("stroke", "black")
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .append('g');
        }

        var text = svgContainer.selectAll("text")
            .data(streetMap)
            .enter()
            .append("text");

        //Add SVG Text Element Attributes
        var textLabels = text
            .attr("x", 240)
            .attr("y", 100+margin.top)
            .attr("font-family", "sans-serif")
            .attr("font-size", "10px")
            .attr("transform", "rotate(14)")
            .attr("fill", "black");


        svgContainer.append('text')
            .attr("class","text")
            .attr("x", 225)
            .attr("y", 185)
            .attr("text-anchor", "middle")
            .attr("font-family", "sans-serif")
            .style("font-size", "10px")
            .text("Work House");

        svgContainer.append('text')
            .attr("class","text")
            .attr("x", 175)
            .attr("y", 318)
            .attr("transform", "rotate(-23)")
            .attr("text-anchor", "middle")
            .attr("font-family", "sans-serif")
            .style("font-size", "8px")
            .text("Broad St");

        svgContainer.append('text')
            .attr("class","text")
            .attr("x", 358)
            .attr("y", -155)
            .attr("transform", "rotate(60)")
            .attr("text-anchor", "middle")
            .attr("font-family", "sans-serif")
            .style("font-size", "8px")
            .text("Brewery");



        d3.csv("deaths_age_sex_clusters.csv", function(deathLocationsClusters){

            var colorBy = d3.select('input[name="mode"]:checked').property("id");
            var numClusters = (d3.select('input[name="mode"]:checked').property("id") != "Cluster") ? -1:d3.select('input[name="clstr"]:checked').property("id");
            console.log(numClusters)

            var deathClusters = d3.nest()
                .key(function(d,i) {
                    //if (colorBy != "Cluster") {return -1}
                    if (d.clusterCount == numClusters) {return d.cluster}
                else {return -2}
                    ;})
                .rollup(function(v) { return {
                    count: v.length,
                    x: d3.mean(v, function(d) { return d.x; }),
                    y: d3.mean(v, function(d) { return d.y; }),
                    gender: d3.mean(v, function(d) { return d.gender; }),
                    clusterCnt: d3.mean(v, function(d) { return d.clusterCount; })
                }; })
                .entries(deathLocationsClusters);

            //Create circles
            svgContainer.selectAll("circle")
                .data(deathClusters)
                .enter()
                .append("circle")
                .attr("cx", function(d,i) {
                    if (d.values.clusterCnt >= -1) { return mapScale*(d.values.x)-xMargin}
                    //else { return mapScale*(d.x)-xMargin }
                    ;
                })
                .attr("cy", function(d) {
                    if (d.values.clusterCnt >= -1) {return yScale-mapScale*(d.values.y)+margin.top};
                })
                .attr("r", function(d,i) {
                    if (colorBy != "Cluster") {return 1.5}
                    if (d.key == -2) {return 0}
                    if (d.key >= -1) {return d.values.count/5}
                    //else { return mapScale*(d.x)-xMargin }
                    ;
                })
                .attr("fill", function(d) {

                    if (d3.select('input[name="mode"]:checked').property("id") == 'Cluster')
                    {
                        return "rgb(" + Math.round(d.values.count * 1.1) + ", " + Math.round(d.values.count * 1.1) + ", 0)";
                    }
                    if (d3.select('input[name="mode"]:checked').property("id") == 'Age')
                    {if (d.age == 0 ) { return "#542788" }
                        if (d.age == 1 ) { return "#998ec3" }
                        if (d.age == 2 ) { return "#d8daeb" }
                        if (d.age == 3 ) { return "#fee0b6" }
                        if (d.age == 4 ) { return "#f1a340" }
                        if (d.age == 5 ) { return "#b35806" }
                        else { return "#c57a1a" }}
                    else
                    {
                        if (d.values.gender == 1 ) { return "#415ec5" }
                        else { return "#c57a1a" }
                        ;
                    }
                        ;
                    });

        });
        d3.csv("pumps.csv", function(waterPumps){

            //console.log(deathLocations)
            //Create circles
            svgContainer.selectAll("pumps")
                .data(waterPumps)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    return mapScale*(d.x)-xMargin
                        ;
                })
                .attr("cy", function(d) {
                    return yScale-mapScale*(d.y)+margin.top;
                })
                .attr("r", 6)
                .attr("fill", "black");

            svgContainer.selectAll("pumps")
                .data(waterPumps)
                .enter()
                .append("text")
                .attr("x", function(d) {
                    return mapScale*(d.x)-xMargin-3
                        ;
                })
                .attr("y", function(d) {
                    return yScale-mapScale*(d.y)+3.8+margin.top;
                })
                .style("font-size", "12px")
                .style("fill","white")
                .text("P");

            drawMapLegend()
        });


        d3.selectAll("input[name='mode']").on("change", function(){
            d3.csv("deaths_age_sex_clusters.csv", function(deathLocationsClusters){


                var colorBy = d3.select('input[name="mode"]:checked').property("id");
                var numClusters = (d3.select('input[name="mode"]:checked').property("id") != "Cluster") ? -1:d3.select('input[name="clstr"]:checked').property("id");
                console.log(numClusters)

                var deathClusters = d3.nest()
                    .key(function(d,i) {
                        //if (colorBy != "Cluster") {return -1}
                        if (d.clusterCount == numClusters) {return d.cluster}
                        else {return -2}
                        ;})
                    .rollup(function(v) { return {
                        count: v.length,
                        x: d3.mean(v, function(d) { return d.x; }),
                        y: d3.mean(v, function(d) { return d.y; }),
                        gender: d3.mean(v, function(d) { return d.gender; }),
                        age: d3.mean(v, function(d) { return d.age; }),
                        clusterCnt: d3.mean(v, function(d) { return d.clusterCount; })
                    }; })
                    .entries(deathLocationsClusters);


                svgContainer.selectAll("circle").remove()
                //Create circles
                svgContainer.selectAll("circle")
                    .data(deathClusters)
                    .enter()
                    .append("circle")
                    .attr("cx", function(d,i) {
                        if (d.values.clusterCnt >= -1) { return mapScale*(d.values.x)-xMargin}
                        //else { return mapScale*(d.x)-xMargin }
                        ;
                    })
                    .attr("cy", function(d) {
                        if (d.values.clusterCnt >= -1) {return yScale-mapScale*(d.values.y)+margin.top};
                    })
                    .attr("r", function(d,i) {
                        if (colorBy != "Cluster") {return 1.5}
                        if (d.key == -2) {return 0}
                        if (d.key >= -1) {return d.values.count/5}
                        //else { return mapScale*(d.x)-xMargin }
                        ;
                    })
                    .attr("fill", function(d) {

                        if (d3.select('input[name="mode"]:checked').property("id") == 'Cluster')
                        {
                            return "rgb(" + Math.round(d.values.count * 1.1) + ", " + Math.round(d.values.count * 1.1) + ", 0)";
                        }
                        if (d3.select('input[name="mode"]:checked').property("id") == 'Age')
                        {if (d.values.age == 0 ) { return "#542788" }
                            if (d.values.age == 1 ) { return "#998ec3" }
                            if (d.values.age == 2 ) { return "#d8daeb" }
                            if (d.values.age == 3 ) { return "#fee0b6" }
                            if (d.values.age == 4 ) { return "#f1a340" }
                            if (d.values.age == 5 ) { return "#b35806" }
                            else { return "#c57a1a" }}
                        else
                        {
                            if (d.values.gender == 1 ) { return "#415ec5" }
                            else { return "#c57a1a" }
                            ;
                        }
                        ;
                    });

                d3.csv("pumps.csv", function(waterPumps){

                    //console.log(deathLocations)
                    //Create circles
                    svgContainer.selectAll("pumps")
                        .data(waterPumps)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d) {
                            return mapScale*(d.x)-xMargin
                                ;
                        })
                        .attr("cy", function(d) {
                            return yScale-mapScale*(d.y)+margin.top;
                        })
                        .attr("r", 6)
                        .attr("fill", "black");

                    svgContainer.selectAll("pumps")
                        .data(waterPumps)
                        .enter()
                        .append("text")
                        .attr("x", function(d) {
                            return mapScale*(d.x)-xMargin-3
                                ;
                        })
                        .attr("y", function(d) {
                            return yScale-mapScale*(d.y)+3.8+margin.top;
                        })
                        .style("font-size", "12px")
                        .style("fill","white")
                        .text("P");

                });
            });


        });


        d3.selectAll("input[name='clstr']").on("change", function(){
            d3.csv("deaths_age_sex_clusters.csv", function(deathLocationsClusters){


                var colorBy = d3.select('input[name="mode"]:checked').property("id");
                var numClusters = (d3.select('input[name="mode"]:checked').property("id") != "Cluster") ? -1:d3.select('input[name="clstr"]:checked').property("id");
                console.log(numClusters)

                var deathClusters = d3.nest()
                    .key(function(d,i) {
                        //if (colorBy != "Cluster") {return -1}
                        if (d.clusterCount == numClusters) {return d.cluster}
                        else {return -2}
                        ;})
                    .rollup(function(v) { return {
                        count: v.length,
                        x: d3.mean(v, function(d) { return d.x; }),
                        y: d3.mean(v, function(d) { return d.y; }),
                        gender: d3.mean(v, function(d) { return d.gender; }),
                        age: d3.mean(v, function(d) { return d.age; }),
                        clusterCnt: d3.mean(v, function(d) { return d.clusterCount; })
                    }; })
                    .entries(deathLocationsClusters);


                svgContainer.selectAll("circle").remove()
                //Create circles
                svgContainer.selectAll("circle")
                    .data(deathClusters)
                    .enter()
                    .append("circle")
                    .attr("cx", function(d,i) {
                        if (d.values.clusterCnt >= -1) { return mapScale*(d.values.x)-xMargin}
                        //else { return mapScale*(d.x)-xMargin }
                        ;
                    })
                    .attr("cy", function(d) {
                        if (d.values.clusterCnt >= -1) {return yScale-mapScale*(d.values.y)+margin.top};
                    })
                    .attr("r", function(d,i) {
                        if (colorBy != "Cluster") {return 1.5}
                        if (d.key == -2) {return 0}
                        if (d.key >= -1) {return d.values.count/5}
                        //else { return mapScale*(d.x)-xMargin }
                        ;
                    })
                    .attr("fill", function(d) {

                        if (d3.select('input[name="mode"]:checked').property("id") == 'Cluster')
                        {
                            return "rgb(" + Math.round(d.values.count * 1.1) + ", " + Math.round(d.values.count * 1.1) + ", 0)";
                        }
                        if (d3.select('input[name="mode"]:checked').property("id") == 'Age')
                        {if (d.values.age == 0 ) { return "#542788" }
                            if (d.values.age == 1 ) { return "#998ec3" }
                            if (d.values.age == 2 ) { return "#d8daeb" }
                            if (d.values.age == 3 ) { return "#fee0b6" }
                            if (d.values.age == 4 ) { return "#f1a340" }
                            if (d.values.age == 5 ) { return "#b35806" }
                            else { return "#c57a1a" }}
                        else
                        {
                            if (d.values.gender == 1 ) { return "#415ec5" }
                            else { return "#c57a1a" }
                            ;
                        }
                        ;
                    });


                d3.csv("pumps.csv", function(waterPumps){

                    //console.log(deathLocations)
                    //Create circles
                    svgContainer.selectAll("pumps")
                        .data(waterPumps)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d) {
                            return mapScale*(d.x)-xMargin
                                ;
                        })
                        .attr("cy", function(d) {
                            return yScale-mapScale*(d.y)+margin.top;
                        })
                        .attr("r", 6)
                        .attr("fill", "black");

                    svgContainer.selectAll("pumps")
                        .data(waterPumps)
                        .enter()
                        .append("text")
                        .attr("x", function(d) {
                            return mapScale*(d.x)-xMargin-3
                                ;
                        })
                        .attr("y", function(d) {
                            return yScale-mapScale*(d.y)+3.8+margin.top;
                        })
                        .style("font-size", "12px")
                        .style("fill","white")
                        .text("P");

                });
            });



        });

    });



    //Deaths by Day bar chart
    d3.csv("deathdays.csv", function(daydays) {

        var cumulative = 0;
        daydays.forEach(function(d) {
            cumulative += +d.deaths;
            d.date = d.date;
            d.deaths = +d.deaths;
            d.cumulativeDeaths = cumulative;
        });


        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var xScale = d3.scale.ordinal()
            .domain(d3.range(daydays.length))
            .rangeRoundBands([9, margin.left+wBar], 0.0);
        var xScaleDate = d3.scale.ordinal()
            .domain(daydays.map(function(d) { return d.date; }))
            .rangeRoundBands([margin.left, margin.left+wBar], 0.0);


        var maxYVal = d3.max(d3.values(daydays), function(d) {return d.deaths;});

        var yScale = d3.scale.linear().range([hBar, 0]);
        yScale.domain([0, maxYVal]);

        svgBar.selectAll("rect")
            .data(daydays)
            .enter()
            .append("rect")
            .attr("x", function(d, i) {
                return xScale(i);
            })
            .attr("y", function(d) { return yScale(d.deaths) ; })
            .attr("height", function(d) { return hBar - yScale(d.deaths); })
            .attr("width", xScale.rangeBand())
            .attr("fill", function(d) {
                return "rgb(" + Math.round(d.deaths * 1.5) + ", " + Math.round(d.deaths * 1.5) + ", 0)";
            })
            .on("mouseover", function(d,i) { if
                (d3.select('input[name="mode"]:checked').property("id") != "Cluster")
            {
                d3.select(this)
                    .attr("fill", "orange");
                var Important = d.cumulativeDeaths;
                div.transition()
                    .duration(200)
                    .style("opacity", .7);
                div	.html(d.date + "<br/>"  + d.deaths)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                d3.json("streets.json", function(streetMap){
                    var yScale= d3.max(d3.values(streetMap), function(d) {return d[0].y*mapScale,d[1].y*mapScale;});
                    var xMargin = d3.min(d3.values(streetMap), function(d) {return d[0].x*mapScale,d[1].x*mapScale;});
                    //Death Locations


                    d3.csv("deaths_age_sex.csv", function(deathLocations){

                        //svgContainer.selectAll("circle").remove()
                        //Create circles
                        svgContainer.selectAll("circle")
                            .data(deathLocations)
                            .attr("cx", function(d,i) {
                                if (i <= Important) { return mapScale*(d.x)-xMargin}
                                else { return null}
                                ;
                            })
                            .attr("cy", function(d,i) {
                                if (i <= Important) { return yScale-mapScale*(d.y)+margin.top}
                                else { return null}
                                ;})
                            .attr("r", 1.5)
                            .attr("fill", function(d) { if (d3.select('input[name="mode"]:checked').property("id") == 'Age')
                            {if (d.age == 0 ) { return "#542788" }
                                if (d.age == 1 ) { return "#998ec3" }
                                if (d.age == 2 ) { return "#d8daeb" }
                                if (d.age == 3 ) { return "#fee0b6" }
                                if (d.age == 4 ) { return "#f1a340" }
                                if (d.age == 5 ) { return "#b35806" }
                                else { return "#c57a1a" }}
                            else
                            {
                                if (d.gender == 1 ) { return "#415ec5" }
                                else { return "#c57a1a" }
                                ;
                            }
                                ;
                            });
                        d3.csv("pumps.csv", function(waterPumps){

                            //console.log(deathLocations)
                            //Create circles
                            svgContainer.selectAll("pumps")
                                .data(waterPumps)
                                .enter()
                                .append("circle")
                                .attr("cx", function(d) {
                                    return mapScale*(d.x)-xMargin
                                        ;
                                })
                                .attr("cy", function(d) {
                                    return yScale-mapScale*(d.y)+margin.top;
                                })
                                .attr("r", 6)
                                .attr("fill", "black");

                            svgContainer.selectAll("pumps")
                                .data(waterPumps)
                                .enter()
                                .append("text")
                                .attr("x", function(d) {
                                    return mapScale*(d.x)-xMargin-3
                                        ;
                                })
                                .attr("y", function(d) {
                                    return yScale-mapScale*(d.y)+3.8+margin.top;
                                })
                                .style("font-size", "12px")
                                .style("fill","white")
                                .text("P");

                        });

                    });
                });
                d3.csv("deaths_age_sex.csv", function(error, csv_data) {

                    csv_data.forEach(function(d,i) {
                        if (i < Important ) {
                            d.x = +d.x;
                            d.y = +d.y;
                            d.age = +d.age;
                            d.gender = +d.gender;
                            d.deathCount = 1;}
                    });


                    var color = d3.scale.ordinal()
                        .range(["#c57a1a","#415ec5"]);
                    var arc = d3.svg.arc()
                        .outerRadius(radius - (10/donutScale))
                        .innerRadius(radius - (70/donutScale));
                    var pie = d3.layout.pie()
                        .sort(null)
                        .value(function(d) { return d.values; });


                    var dataDonut = d3.nest()
                        .key(function(d) { return d.gender;})
                        .rollup(function(d) {
                            return d3.sum(d, function(d) {return d.deathCount; });
                        }).entries(csv_data);

                    svgDonut.selectAll("g")
                        .data(pie(dataDonut))
                        //.enter().append("g")
                        .attr("class", "arc");

                    svgDonut.selectAll("g")
                        .select("path")
                        .attr("d", arc)
                        .style("fill", function(d) { return color(d.data.key); });
                    svgDonut.selectAll("g")
                        .select("text")
                        .attr("class", "arc")
                        .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
                        .attr("dy", ".35em")
                        .attr("dx", "-.6em")
                        .text(function(d) {if (d.data.key == "0") { return d.data.values + ' females' }
                        else { return  d.data.values + ' males' }
                            ;
                        });


                    var totalDeaths = d3.nest()
                        .key(function(d) { return 1;})
                        .rollup(function(d) {
                            return d3.sum(d, function(g) {return 1; });
                        }).entries(csv_data);

                })



                // Bar chart action on Scatter
                d3.csv('deaths_age_sex.csv', function(deathsByAge)
                {

                    var deathsByAge1 = deathsByAge;
                    deathsByAge1.forEach(function(d,i) {
                        if (i < Important ) {
                            d.x = +d.x;
                            d.y = +d.y;
                            d.age = +d.age;
                            d.gender = +d.gender;
                            d.deathCount = 1;}
                        if (i >= Important ) {
                            d.x = +d.x;
                            d.y = +d.y;
                            d.age = +d.age;
                            d.gender = +d.gender;
                            d.deathCount = 0;}
                    });

                    var deathsByAgeData = d3.nest()
                        .key(function(d,i) { return d.age
                            ;})
                        .rollup(function(d,i) {
                            return d3.sum(d, function(d) { return d.deathCount});}
                        ).entries(deathsByAge1);



                    var totalDeaths = d3.nest()
                        .key(function(d) { return 1;})
                        .rollup(function(d) {
                            return d3.sum(d, function(d,i) {return d.deathCount})
                                ;
                        }).entries(deathsByAge1);

                    var totalDeathCount = totalDeaths[0].values;

                    deathsByAgeData.forEach(function(d,i) {
                        if (d.key == 0) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .28;
                            d.AgeGroup = '0-10'
                        }
                        if (d.key == 1) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .25;
                            d.AgeGroup = '11-20'}
                        if (d.key == 2) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .30;
                            d.AgeGroup = '21-40';}
                        if (d.key == 3) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .13;
                            d.AgeGroup = '41-60';}
                        if (d.key == 4) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .04;
                            d.AgeGroup = '61-80';}
                        if (d.key == 5) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .01;
                            d.AgeGroup = '> 80';}
                    });

                    var xScale = d3.scale.linear();
                    var yScale = d3.scale.linear();

                    var xScaleMax= d3.max(d3.values(deathsByAgeData), function(d) {return d.CensusPct;});
                    var yScaleMax= d3.max(d3.values(deathsByAgeData), function(d) {return d.Percent;});


                    xScale.domain([0, xScaleMax + .1]).range([0, ScatterWidth-margin.left]);
                    yScale.domain([0, yScaleMax + .1]).range([ScatterHeight-margin.top, margin.bottom]);

                    svgScatterPlot.selectAll("circle")
                        .data(deathsByAgeData)
                        //.enter()
                        //.append("circle")
                        .attr("cx", function(d,i) {
                            return xScale(d.CensusPct)+margin.left+25
                                ;
                        })
                        .attr("cy", function(d,i) {
                            return yScale(d.Percent)-margin.bottom+17
                                ;
                        })
                        .attr("r", 7)
                        .attr("fill", function(d) {
                            if (d.key == 0 ) { return "#542788" }
                            if (d.key == 1 ) { return "#998ec3" }
                            if (d.key == 2 ) { return "#d8daeb" }
                            if (d.key == 3 ) { return "#fee0b6" }
                            if (d.key == 4 ) { return "#f1a340" }
                            if (d.key == 5 ) { return "#b35806" } }
                        );


                    svgScatterPlot.selectAll("text")  // <-- Note "text", not "circle" or "rect"
                        .data(deathsByAgeData)

                        //.enter()
                        //.append("text")     // <-- Same here!
                        .attr("x", function(d) {
                            return xScale(d.CensusPct)+margin.left+25+10
                                ;
                        })
                        .attr("y", function(d) {
                            return yScale(d.Percent)-margin.bottom+17
                                ;
                        })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "10px")
                        .attr("fill", "black")
                        .text(function(d) {
                            return d.AgeGroup;
                        });

                    var g = d3.select('svgScatterPlot').select('g');



                    var xAxis = d3.svg.axis()
                        .scale(xScale)
                        .orient("bottom")
                        .tickFormat(formatPercent);;

                    var yAxis = d3.svg.axis()
                        .scale(yScale)
                        .orient("left")
                        .ticks(10)
                        .tickFormat(formatPercent);
                    ;


                    svgScatterPlot.selectAll('g.yaxis')
                    //.attr('class', 'axis')
                        .attr("transform", "translate(" + (margin.left+25) +", -15  )")
                        .call(yAxis)
                        .append("text")
                        .attr("class", "label")
                        .attr("transform", "rotate(-90)")
                        .attr("y", -30)
                        .attr("x", -100)
                        .style("text-anchor", "end")
                        .style("font-size", "10px")
                    //.text("% of Total Cholera Deaths");



                });}
            })
            .on("mouseout", function(d,i) {if
                (d3.select('input[name="mode"]:checked').property("id") != "Cluster")
                {
                d3.select(this)
                    .transition()
                    .duration(250)
                    .attr("fill", function(d) {
                        return "rgb(" + Math.round(d.deaths * 1.5) + ", " + Math.round(d.deaths * 1.5) + ", 0)";
                    });
                var Important = 9999;
                div.transition()
                    .style("opacity", 0);
                d3.json("streets.json", function(streetMap){
                    var yScale= d3.max(d3.values(streetMap), function(d) {return d[0].y*mapScale,d[1].y*mapScale;});
                    var xMargin = d3.min(d3.values(streetMap), function(d) {return d[0].x*mapScale,d[1].x*mapScale;});
                    //Death Locations
                    d3.csv("deaths_age_sex.csv", function(deathLocations){
                        //Create circles
                        //svgContainer.selectAll("circle").remove();
                        svgContainer.selectAll("circle")
                            .data(deathLocations)
                            //.enter()
                            //.append("circle")
                            .attr("cx", function(d) {
                                return mapScale*(d.x)-xMargin;})
                            .attr("cy", function(d) {
                                return yScale-mapScale*(d.y)+margin.top;
                            })
                            .attr("r", 1.5)
                            .attr("fill", function(d) { if (d3.select('input[name="mode"]:checked').property("id") == 'Age')
                            {if (d.age == 0 ) { return "#542788" }
                                if (d.age == 1 ) { return "#998ec3" }
                                if (d.age == 2 ) { return "#d8daeb" }
                                if (d.age == 3 ) { return "#fee0b6" }
                                if (d.age == 4 ) { return "#f1a340" }
                                if (d.age == 5 ) { return "#b35806" }
                                else { return "#c57a1a" }}
                            else
                            {
                                if (d.gender == 1 ) { return "#415ec5" }
                                else { return "#c57a1a" }
                                ;
                            }
                                ;
                            });

                    });
                });
                d3.csv("deaths_age_sex.csv", function(error, csv_data) {
                    var Important = 9999;
                    csv_data.forEach(function(d,i) {
                        if (i < Important ) {
                            d.x = +d.x;
                            d.y = +d.y;
                            d.age = +d.age;
                            d.gender = +d.gender;
                            d.deathCount = 1;}
                    });


                    var color = d3.scale.ordinal()
                        .range(["#c57a1a","#415ec5"]);
                    var arc = d3.svg.arc()
                        .outerRadius(radius - (10/donutScale))
                        .innerRadius(radius - (70/donutScale));
                    var pie = d3.layout.pie()
                        .sort(null)
                        .value(function(d) { return d.values; });


                    var dataDonut = d3.nest()
                        .key(function(d) { return d.gender;})
                        .rollup(function(d) {
                            return d3.sum(d, function(d) {return d.deathCount; });
                        }).entries(csv_data);

                    svgDonut.selectAll("g")
                        .data(pie(dataDonut))
                        //.enter().append("g")
                        .attr("class", "arc");

                    svgDonut.selectAll("g")
                        .select("path")
                        .attr("d", arc)
                        .style("fill", function(d) { return color(d.data.key); });
                    svgDonut.selectAll("g")
                        .select("text")
                        .attr("class", "arc")
                        .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
                        .attr("dy", ".35em")
                        .attr("dx", "-.6em")
                        .text(function(d) {if (d.data.key == "0") { return d.data.values + ' females' }
                        else { return  d.data.values + ' males' }
                            ;
                        });


                    var totalDeaths = d3.nest()
                        .key(function(d) { return 1;})
                        .rollup(function(d) {
                            return d3.sum(d, function(g) {return 1; });
                        }).entries(csv_data);

                })


                // Bar chart action on Scatter
                d3.csv('deaths_age_sex.csv', function(deathsByAge)
                {
                    var Important = 9999;
                    var deathsByAgeData = d3.nest()
                        .key(function(d,i) { return d.age
                            ;})
                        .rollup(function(d) {
                            return d3.sum(d, function(d,i) {if (i <= Important) { return 1}
                            else { return null}
                                ; });
                        }).entries(deathsByAge);


                    var totalDeaths = d3.nest()
                        .key(function(d) { return 1;})
                        .rollup(function(d) {
                            return d3.sum(d, function(d,i) {if (i <= Important) { return 1}
                            else { return null}
                                ; });
                        }).entries(deathsByAge);

                    var totalDeathCount = totalDeaths[0].values;

                    deathsByAgeData.forEach(function(d,i) {
                        if (d.key == 0) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .28;
                            d.AgeGroup = '0-10'
                        }
                        if (d.key == 1) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .25;
                            d.AgeGroup = '11-20'}
                        if (d.key == 2) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .30;
                            d.AgeGroup = '21-40';}
                        if (d.key == 3) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .13;
                            d.AgeGroup = '41-60';}
                        if (d.key == 4) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .04;
                            d.AgeGroup = '61-80';}
                        if (d.key == 5) {
                            d.Age = +d.key;
                            d.Deaths = +d.values;
                            d.Percent = d.Deaths/totalDeathCount;
                            d.CensusPct = .01;
                            d.AgeGroup = '> 80';}
                    });


                    var xScale = d3.scale.linear();
                    var yScale = d3.scale.linear();

                    var xScaleMax= d3.max(d3.values(deathsByAgeData), function(d) {return d.CensusPct;});
                    var yScaleMax= d3.max(d3.values(deathsByAgeData), function(d) {return d.Percent;});


                    xScale.domain([0, xScaleMax + .1]).range([0, ScatterWidth-margin.left]);
                    yScale.domain([0, yScaleMax + .1]).range([ScatterHeight-margin.top, margin.bottom]);

                    svgScatterPlot.selectAll("circle")
                        .data(deathsByAgeData)
                        //.enter()
                        //.append("circle")
                        .attr("cx", function(d,i) {
                            return xScale(d.CensusPct)+margin.left+25
                                ;
                        })
                        .attr("cy", function(d,i) {
                            return yScale(d.Percent)-margin.bottom+17
                                ;
                        })
                        .attr("r", 7)
                        .attr("fill", function(d) {
                            if (d.key == 0 ) { return "#542788" }
                            if (d.key == 1 ) { return "#998ec3" }
                            if (d.key == 2 ) { return "#d8daeb" }
                            if (d.key == 3 ) { return "#fee0b6" }
                            if (d.key == 4 ) { return "#f1a340" }
                            if (d.key == 5 ) { return "#b35806" } }
                        );

                    svgScatterPlot.selectAll("text")  // <-- Note "text", not "circle" or "rect"
                        .data(deathsByAgeData)
                        //.enter()
                        //.append("text")     // <-- Same here!
                        .attr("x", function(d) {
                            return xScale(d.CensusPct)+margin.left+25+10
                                ;
                        })
                        .attr("y", function(d) {
                            return yScale(d.Percent)-margin.bottom+17
                                ;
                        })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "12px")
                        .attr("fill", "black")
                        .text(function(d) {
                            return d.AgeGroup;
                        });

                    var g = d3.select('svgScatterPlot').select('g');



                    var xAxis = d3.svg.axis()
                        .scale(xScale)
                        .orient("bottom")
                        .tickFormat(formatPercent);

                    var yAxis = d3.svg.axis()
                        .scale(yScale)
                        .orient("left")
                        .ticks(10)
                        .tickFormat(formatPercent);


                    svgScatterPlot.append('g')
                        .attr('class', 'axis')
                        .attr("transform", "translate(" + (margin.left+25) +", -15  )")
                        .call(yAxis)
                        //.append("text")
                        .attr("class", "label")
                        .attr("transform", "rotate(-90)")
                        .attr("y", -30)
                        .attr("x", -100)
                        .style("text-anchor", "end")
                        .style("font-size", "10px")
                        .text("% of Total Cholera Deaths");



                });}
            });

        var xAxis = d3.svg.axis()
            .scale(xScaleDate)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left")
            .ticks(10);

        svgBar.append("text")
            .attr("x", (wBar / 2))
            .attr("y", 0 - (margin.top / 2.5))
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-family", "sans-serif")
            .text("Cholera Deaths by Date - 1854");

        svgBar.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(3," +(hBar+2) + ")")
            .call(xAxis)
            .selectAll("text")
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(90)")
            .style("text-anchor", "start");

        svgBar.append('g')
            .attr('class', 'axis')
            .attr("transform", "translate(18," + 1 + ")")
            .call(yAxis);

    });


    // Donut chart by gender
    d3.csv("deaths_age_sex.csv", function(error, csv_data) {


        csv_data.forEach(function(d,i) {
            if (i < 9999 ) {
                d.x = +d.x;
                d.y = +d.y;
                d.age = +d.age;
                d.gender = +d.gender;
                d.deathCount = 1;}
        });


        var color = d3.scale.ordinal()
            .range(["#c57a1a","#415ec5"]);
        var arc = d3.svg.arc()
            .outerRadius(radius - (10/donutScale))
            .innerRadius(radius - (70/donutScale));
        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d.values; });


        var dataDonut = d3.nest()
            .key(function(d) { return d.gender;})
            .rollup(function(d) {
                return d3.sum(d, function(d) {return d.deathCount; });
            }).entries(csv_data);

        svgDonut.selectAll("g")
            .data(pie(dataDonut))
            .enter().append("g")
            .attr("class", "arc");

        svgDonut.selectAll("g")
            .append("path")
            .attr("d", arc)
            .style("fill", function(d) { return color(d.data.key); });
        svgDonut.selectAll("g")
            .append("text")
            .attr("class", "arc")
            .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
            .attr("dy", ".35em")
            .attr("dx", "-.6em")
            .text(function(d) {if (d.data.key == "0") { return d.data.values + ' females' }
            else { return  d.data.values + ' males' }
                ;
            })
            .on("mouseover", function(d,i) {
                if
                (d3.select('input[name="mode"]:checked').property("id") != "Cluster") {
                    d3.select(this)
                        .attr("fill", "orange");
                    var genderSelection = d.data.key;

                    d3.json("streets.json", function (streetMap) {
                        var yScale = d3.max(d3.values(streetMap), function (d) {
                            return d[0].y * mapScale, d[1].y * mapScale;
                        });
                        var xMargin = d3.min(d3.values(streetMap), function (d) {
                            return d[0].x * mapScale, d[1].x * mapScale;
                        });
                        //Death Locations
                        d3.csv("deaths_age_sex.csv", function (deathLocations) {

                            //console.log(deathLocations)
                            //svgContainer.selectAll("circle").remove()
                            //Create circles
                            svgContainer.selectAll("circle")
                                .data(deathLocations)
                                //.enter()
                                //.append("circle")
                                .attr("cx", function (d, i) {
                                    if (d.gender == genderSelection) {
                                        return mapScale * (d.x) - xMargin
                                    } else {
                                        return null
                                    }
                                    ;
                                })
                                .attr("cy", function (d, i) {
                                    if (d.gender == genderSelection) {
                                        return yScale - mapScale * (d.y) + margin.top
                                    } else {
                                        return null
                                    }
                                    ;
                                })
                                .attr("r", 1.5)
                                .attr("fill", function (d) {
                                    if (d3.select('input[name="mode"]:checked').property("id") == 'Age') {
                                        if (d.age == 0) {
                                            return "#542788"
                                        }
                                        if (d.age == 1) {
                                            return "#998ec3"
                                        }
                                        if (d.age == 2) {
                                            return "#d8daeb"
                                        }
                                        if (d.age == 3) {
                                            return "#fee0b6"
                                        }
                                        if (d.age == 4) {
                                            return "#f1a340"
                                        }
                                        if (d.age == 5) {
                                            return "#b35806"
                                        } else {
                                            return "#c57a1a"
                                        }
                                    } else {
                                        if (d.gender == 1) {
                                            return "#415ec5"
                                        } else {
                                            return "#c57a1a"
                                        }
                                        ;
                                    }
                                    ;
                                });


                        });
                    });
                    // Donut chart action on Scatter
                    d3.csv('deaths_age_sex.csv', function (deathsByAge) {

                        var deathsByAgeData = d3.nest()
                            .key(function (d) {
                                if (d.gender == genderSelection) {
                                    return d.age
                                } else {
                                    return null
                                }
                                ;
                            })
                            .rollup(function (d) {
                                return d3.sum(d, function (d) {
                                    if (d.gender == genderSelection) {
                                        return 1
                                    } else {
                                        return null
                                    }
                                    ;
                                });
                            }).entries(deathsByAge);

                        var totalDeaths = d3.nest()
                            .key(function (d) {
                                return 1;
                            })
                            .rollup(function (d) {
                                return d3.sum(d, function (d) {
                                    if (d.gender == genderSelection) {
                                        return 1
                                    } else {
                                        return null
                                    }
                                    ;
                                });
                            }).entries(deathsByAge);

                        var totalDeathCount = totalDeaths[0].values;

                        deathsByAgeData.forEach(function (d, i) {
                            if (d.key == 0) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .28;
                                d.AgeGroup = '0-10'
                            }
                            if (d.key == 1) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .25;
                                d.AgeGroup = '11-20'
                            }
                            if (d.key == 2) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .30;
                                d.AgeGroup = '21-40';
                            }
                            if (d.key == 3) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .13;
                                d.AgeGroup = '41-60';
                            }
                            if (d.key == 4) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .04;
                                d.AgeGroup = '61-80';
                            }
                            if (d.key == 5) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .01;
                                d.AgeGroup = '> 80';
                            }
                        });


                        var xScale = d3.scale.linear();
                        var yScale = d3.scale.linear();

                        var xScaleMax = d3.max(d3.values(deathsByAgeData), function (d) {
                            return d.CensusPct;
                        });
                        var yScaleMax = d3.max(d3.values(deathsByAgeData), function (d) {
                            return d.Percent;
                        });


                        xScale.domain([0, xScaleMax + .1]).range([0, ScatterWidth - margin.left]);
                        yScale.domain([0, yScaleMax + .1]).range([ScatterHeight - margin.top, margin.bottom]);

                        svgScatterPlot.selectAll("circle")
                            .data(deathsByAgeData)
                            //.enter()
                            //.append("circle")
                            .attr("cx", function (d, i) {
                                return xScale(d.CensusPct) + margin.left + 25
                                    ;
                            })
                            .attr("cy", function (d, i) {
                                return yScale(d.Percent) - margin.bottom + 17
                                    ;
                            })
                            .attr("r", 7)
                            .attr("fill", function (d) {
                                    if (d.key == 0) {
                                        return "#542788"
                                    }
                                    if (d.key == 1) {
                                        return "#998ec3"
                                    }
                                    if (d.key == 2) {
                                        return "#d8daeb"
                                    }
                                    if (d.key == 3) {
                                        return "#fee0b6"
                                    }
                                    if (d.key == 4) {
                                        return "#f1a340"
                                    }
                                    if (d.key == 5) {
                                        return "#b35806"
                                    }
                                }
                            );

                        svgScatterPlot.selectAll("text")  // <-- Note "text", not "circle" or "rect"
                            .data(deathsByAgeData)
                            //.enter()
                            //.append("text")     // <-- Same here!
                            .attr("x", function (d) {
                                return xScale(d.CensusPct) + margin.left + 25 + 10
                                    ;
                            })
                            .attr("y", function (d) {
                                return yScale(d.Percent) - margin.bottom + 17
                                    ;
                            })
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "10px")
                            .attr("fill", "black")
                            .text(function (d) {
                                return d.AgeGroup;
                            });

                        var g = d3.select('svgScatterPlot').select('g');


                        var xAxis = d3.svg.axis()
                            .scale(xScale)
                            .orient("bottom")
                            .tickFormat(formatPercent);

                        var yAxis = d3.svg.axis()
                            .scale(yScale)
                            .orient("left")
                            .ticks(10)
                            .tickFormat(formatPercent);


                        svgScatterPlot.append('g')
                            .attr('class', 'axis')
                            .attr("transform", "translate(" + (margin.left + 25) + ", -15  )")
                            .call(yAxis)
                            //.append("text")
                            .attr("class", "label")
                            .attr("transform", "rotate(-90)")
                            .attr("y", -30)
                            .attr("x", -100)
                            .style("text-anchor", "end")
                            .style("font-size", "10px")
                            .text("% of Total Cholera Deaths");


                    });
                }

            })
            .on("mouseout", function(d,i) {
                if
                (d3.select('input[name="mode"]:checked').property("id") != "Cluster") {
                    d3.select(this)
                        .attr("fill", "black");
                    var genderSelection = d.data.key;

                    d3.json("streets.json", function (streetMap) {
                        var yScale = d3.max(d3.values(streetMap), function (d) {
                            return d[0].y * mapScale, d[1].y * mapScale;
                        });
                        var xMargin = d3.min(d3.values(streetMap), function (d) {
                            return d[0].x * mapScale, d[1].x * mapScale;
                        });
                        //Death Locations
                        d3.csv("deaths_age_sex.csv", function (deathLocations) {

                            //console.log(deathLocations)
                            //Create circles
                            svgContainer.selectAll("circle")
                                .data(deathLocations)
                                .attr("cx", function (d, i) {
                                    return mapScale * (d.x) - xMargin
                                })
                                .attr("cy", function (d, i) {
                                    return yScale - mapScale * (d.y) + margin.top
                                })

                                .attr("r", 1.5)
                                .attr("fill", function (d) {
                                    if (d3.select('input[name="mode"]:checked').property("id") == 'Age') {
                                        if (d.age == 0) {
                                            return "#542788"
                                        }
                                        if (d.age == 1) {
                                            return "#998ec3"
                                        }
                                        if (d.age == 2) {
                                            return "#d8daeb"
                                        }
                                        if (d.age == 3) {
                                            return "#fee0b6"
                                        }
                                        if (d.age == 4) {
                                            return "#f1a340"
                                        }
                                        if (d.age == 5) {
                                            return "#b35806"
                                        } else {
                                            return "#c57a1a"
                                        }
                                    } else {
                                        if (d.gender == 1) {
                                            return "#415ec5"
                                        } else {
                                            return "#c57a1a"
                                        }
                                        ;
                                    }
                                    ;
                                });

                        });
                    });

                    // Donut chart action on Scatter
                    d3.csv('deaths_age_sex.csv', function (deathsByAge) {

                        var deathsByAgeData = d3.nest()
                            .key(function (d) {
                                return d.age
                                    ;
                            })
                            .rollup(function (d) {
                                return d3.sum(d, function (d) {
                                    return 1;
                                });
                            }).entries(deathsByAge);

                        var totalDeaths = d3.nest()
                            .key(function (d) {
                                return 1;
                            })
                            .rollup(function (d) {
                                return d3.sum(d, function (g) {
                                    return 1;
                                });
                            }).entries(deathsByAge);

                        var totalDeathCount = totalDeaths[0].values;

                        deathsByAgeData.forEach(function (d, i) {
                            if (d.key == 0) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .28;
                                d.AgeGroup = '0-10'
                            }
                            if (d.key == 1) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .25;
                                d.AgeGroup = '11-20'
                            }
                            if (d.key == 2) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .30;
                                d.AgeGroup = '21-40';
                            }
                            if (d.key == 3) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .13;
                                d.AgeGroup = '41-60';
                            }
                            if (d.key == 4) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .04;
                                d.AgeGroup = '61-80';
                            }
                            if (d.key == 5) {
                                d.Age = +d.key;
                                d.Deaths = +d.values;
                                d.Percent = d.Deaths / totalDeathCount;
                                d.CensusPct = .01;
                                d.AgeGroup = '> 80';
                            }
                        });


                        var xScale = d3.scale.linear();
                        var yScale = d3.scale.linear();

                        var xScaleMax = d3.max(d3.values(deathsByAgeData), function (d) {
                            return d.CensusPct;
                        });
                        var yScaleMax = d3.max(d3.values(deathsByAgeData), function (d) {
                            return d.Percent;
                        });


                        xScale.domain([0, xScaleMax + .1]).range([0, ScatterWidth - margin.left]);
                        yScale.domain([0, yScaleMax + .1]).range([ScatterHeight - margin.top, margin.bottom]);

                        svgScatterPlot.selectAll("circle")
                            .data(deathsByAgeData)
                            //.enter()
                            //.append("circle")
                            .attr("cx", function (d, i) {
                                return xScale(d.CensusPct) + margin.left + 25
                                    ;
                            })
                            .attr("cy", function (d, i) {
                                return yScale(d.Percent) - margin.bottom + 17
                                    ;
                            })
                            .attr("r", 7)
                            .attr("fill", function (d) {
                                    if (d.key == 0) {
                                        return "#542788"
                                    }
                                    if (d.key == 1) {
                                        return "#998ec3"
                                    }
                                    if (d.key == 2) {
                                        return "#d8daeb"
                                    }
                                    if (d.key == 3) {
                                        return "#fee0b6"
                                    }
                                    if (d.key == 4) {
                                        return "#f1a340"
                                    }
                                    if (d.key == 5) {
                                        return "#b35806"
                                    }
                                }
                            );

                        svgScatterPlot.selectAll("text")  // <-- Note "text", not "circle" or "rect"
                            .data(deathsByAgeData)
                            //.enter()
                            //.append("text")     // <-- Same here!
                            .attr("x", function (d) {
                                return xScale(d.CensusPct) + margin.left + 25 + 10
                                    ;
                            })
                            .attr("y", function (d) {
                                return yScale(d.Percent) - margin.bottom + 17
                                    ;
                            })
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "10px")
                            .attr("fill", "black")
                            .text(function (d) {
                                return d.AgeGroup;
                            });

                        var g = d3.select('svgScatterPlot').select('g');


                        var xAxis = d3.svg.axis()
                            .scale(xScale)
                            .orient("bottom")
                            .tickFormat(formatPercent);

                        var yAxis = d3.svg.axis()
                            .scale(yScale)
                            .orient("left")
                            .ticks(10)
                            .tickFormat(formatPercent);


                        svgScatterPlot.append('g')
                            .attr('class', 'axis')
                            .attr("transform", "translate(" + (margin.left + 25) + ", -15  )")
                            .call(yAxis)
                            //.append("text")
                            .attr("class", "label")
                            .attr("transform", "rotate(-90)")
                            .attr("y", -30)
                            .attr("x", -100)
                            .style("text-anchor", "end")
                            .style("font-size", "10px")
                            .text("% of Total Cholera Deaths");


                    });
                }
            });

        var totalDeaths = d3.nest()
            .key(function(d) { return 1;})
            .rollup(function(d) {
                return d3.sum(d, function(g) {return 1; });
            }).entries(csv_data);


        //d.data.values +"/ "+d.data.key; });
    });

    d3.csv('deaths_age_sex.csv', function(deathsByAge)
    {

        var deathsByAgeData = d3.nest()
            .key(function(d) { return d.age;})
            .rollup(function(d) {
                return d3.sum(d, function(d) {return 1; });
            }).entries(deathsByAge);

        var totalDeaths = d3.nest()
            .key(function(d) { return 1;})
            .rollup(function(d) {
                return d3.sum(d, function(g) {return 1; });
            }).entries(deathsByAge);

        var totalDeathCount = totalDeaths[0].values;

        deathsByAgeData.forEach(function(d,i) {
            if (d.key == 0) {
                d.Age = +d.key;
                d.Deaths = +d.values;
                d.Percent = d.Deaths/totalDeathCount;
                d.CensusPct = .28;
                d.AgeGroup = '0-10'
            }
            if (d.key == 1) {
                d.Age = +d.key;
                d.Deaths = +d.values;
                d.Percent = d.Deaths/totalDeathCount;
                d.CensusPct = .25;
                d.AgeGroup = '11-20'}
            if (d.key == 2) {
                d.Age = +d.key;
                d.Deaths = +d.values;
                d.Percent = d.Deaths/totalDeathCount;
                d.CensusPct = .30;
                d.AgeGroup = '21-40';}
            if (d.key == 3) {
                d.Age = +d.key;
                d.Deaths = +d.values;
                d.Percent = d.Deaths/totalDeathCount;
                d.CensusPct = .13;
                d.AgeGroup = '41-60';}
            if (d.key == 4) {
                d.Age = +d.key;
                d.Deaths = +d.values;
                d.Percent = d.Deaths/totalDeathCount;
                d.CensusPct = .04;
                d.AgeGroup = '61-80';}
            if (d.key == 5) {
                d.Age = +d.key;
                d.Deaths = +d.values;
                d.Percent = d.Deaths/totalDeathCount;
                d.CensusPct = .01;
                d.AgeGroup = '> 80';}
        });




        var xScale = d3.scale.linear();
        var yScale = d3.scale.linear();

        var xScaleMax= d3.max(d3.values(deathsByAgeData), function(d) {return d.CensusPct;});
        var yScaleMax= d3.max(d3.values(deathsByAgeData), function(d) {return d.Percent;});


        xScale.domain([0, xScaleMax + .1]).range([0, ScatterWidth-margin.left]);
        yScale.domain([0, yScaleMax + .1]).range([ScatterHeight-margin.top, margin.bottom]);

        svgScatterPlot.selectAll("circle")
            .data(deathsByAgeData)
            .enter()
            .append("circle")
            .attr("cx", function(d,i) {
                return xScale(d.CensusPct)+margin.left+25
                    ;
            })
            .attr("cy", function(d,i) {
                return yScale(d.Percent)-margin.bottom+17
                    ;
            })
            .attr("r", 7)
            .attr("fill", function(d) {
                if (d.key == 0 ) { return "#542788" }
                if (d.key == 1 ) { return "#998ec3" }
                if (d.key == 2 ) { return "#d8daeb" }
                if (d.key == 3 ) { return "#fee0b6" }
                if (d.key == 4 ) { return "#f1a340" }
                if (d.key == 5 ) { return "#b35806" } }
            )
            .on("mouseover", function(d,i) {
                if
                (d3.select('input[name="mode"]:checked').property("id") != "Cluster") {
                    d3.select(this)
                        .attr("r", "12");
                    var AgeGroup = d.key;
                    d3.csv("deaths_age_sex.csv", function (error, csv_data) {

                        csv_data.forEach(function (d, i) {
                            if (d.age == AgeGroup) {
                                d.x = +d.x;
                                d.y = +d.y;
                                d.age = +d.age;
                                d.gender = +d.gender;
                                d.deathCount = 1;
                            }
                        });


                        var color = d3.scale.ordinal()
                            .range(["#c57a1a", "#415ec5"]);
                        var arc = d3.svg.arc()
                            .outerRadius(radius - (10 / donutScale))
                            .innerRadius(radius - (70 / donutScale));
                        var pie = d3.layout.pie()
                            .sort(null)
                            .value(function (d) {
                                return d.values;
                            });


                        var dataDonut = d3.nest()
                            .key(function (d) {
                                return d.gender;
                            })
                            .rollup(function (d) {
                                return d3.sum(d, function (d) {
                                    return d.deathCount;
                                });
                            }).entries(csv_data);

                        svgDonut.selectAll("g")
                            .data(pie(dataDonut))
                            //.enter().append("g")
                            .attr("class", "arc");

                        svgDonut.selectAll("g")
                            .select("path")
                            .attr("d", arc)
                            .style("fill", function (d) {
                                return color(d.data.key);
                            });
                        svgDonut.selectAll("g")
                            .select("text")
                            .attr("class", "arc")
                            .attr("transform", function (d) {
                                return "translate(" + arc.centroid(d) + ")";
                            })
                            .attr("dy", ".35em")
                            .attr("dx", "-.6em")
                            .text(function (d) {
                                if (d.data.key == "0") {
                                    return d.data.values + ' females'
                                } else {
                                    return d.data.values + ' males'
                                }
                                ;
                            });


                    })


                    d3.json("streets.json", function (streetMap) {
                        var yScale = d3.max(d3.values(streetMap), function (d) {
                            return d[0].y * mapScale, d[1].y * mapScale;
                        });
                        var xMargin = d3.min(d3.values(streetMap), function (d) {
                            return d[0].x * mapScale, d[1].x * mapScale;
                        });
                        //Death Locations
                        d3.csv("deaths_age_sex.csv", function (deathLocations) {

                            //console.log(deathLocations)
                            //Create circles
                            //svgContainer.selectAll("circle").remove()
                            svgContainer.selectAll("circle")
                                .data(deathLocations)
                                //.enter()
                                //.append("circle")
                                .attr("cx", function (d, i) {
                                    if (d.age == AgeGroup) {
                                        return mapScale * (d.x) - xMargin
                                    } else {
                                        return null
                                    }
                                    ;
                                })
                                .attr("cy", function (d, i) {
                                    if (d.age == AgeGroup) {
                                        return yScale - mapScale * (d.y) + margin.top
                                    } else {
                                        return null
                                    }
                                    ;
                                })
                                .attr("r", 1.5)
                                .attr("fill", function (d) {
                                    if (d3.select('input[name="mode"]:checked').property("id") == 'Age') {
                                        if (d.age == 0) {
                                            return "#542788"
                                        }
                                        if (d.age == 1) {
                                            return "#998ec3"
                                        }
                                        if (d.age == 2) {
                                            return "#d8daeb"
                                        }
                                        if (d.age == 3) {
                                            return "#fee0b6"
                                        }
                                        if (d.age == 4) {
                                            return "#f1a340"
                                        }
                                        if (d.age == 5) {
                                            return "#b35806"
                                        } else {
                                            return "#c57a1a"
                                        }
                                    } else {
                                        if (d.gender == 1) {
                                            return "#415ec5"
                                        } else {
                                            return "#c57a1a"
                                        }
                                        ;
                                    }
                                    ;
                                });


                        });
                    });

                }

            })
            .on("mouseout", function(d,i) {if
            (d3.select('input[name="mode"]:checked').property("id") != "Cluster") {
                d3.select(this)
                    .attr("r", "7");
                var AgeGroup = d.key;
                d3.csv("deaths_age_sex.csv", function (error, csv_data) {

                    csv_data.forEach(function (d, i) {
                        if (1 == 1) {
                            d.x = +d.x;
                            d.y = +d.y;
                            d.age = +d.age;
                            d.gender = +d.gender;
                            d.deathCount = 1;
                        }
                    });


                    var color = d3.scale.ordinal()
                        .range(["#c57a1a", "#415ec5"]);
                    var arc = d3.svg.arc()
                        .outerRadius(radius - (10 / donutScale))
                        .innerRadius(radius - (70 / donutScale));
                    var pie = d3.layout.pie()
                        .sort(null)
                        .value(function (d) {
                            return d.values;
                        });


                    var dataDonut = d3.nest()
                        .key(function (d) {
                            return d.gender;
                        })
                        .rollup(function (d) {
                            return d3.sum(d, function (d) {
                                return d.deathCount;
                            });
                        }).entries(csv_data);

                    svgDonut.selectAll("g")
                        .data(pie(dataDonut))
                        //.enter().append("g")
                        .attr("class", "arc");

                    svgDonut.selectAll("g")
                        .select("path")
                        .attr("d", arc)
                        .style("fill", function (d) {
                            return color(d.data.key);
                        });
                    svgDonut.selectAll("g")
                        .select("text")
                        .attr("class", "arc")
                        .attr("transform", function (d) {
                            return "translate(" + arc.centroid(d) + ")";
                        })
                        .attr("dy", ".35em")
                        .attr("dx", "-.6em")
                        .text(function (d) {
                            if (d.data.key == "0") {
                                return d.data.values + ' females'
                            } else {
                                return d.data.values + ' males'
                            }
                            ;
                        });


                })


                d3.json("streets.json", function (streetMap) {
                    var yScale = d3.max(d3.values(streetMap), function (d) {
                        return d[0].y * mapScale, d[1].y * mapScale;
                    });
                    var xMargin = d3.min(d3.values(streetMap), function (d) {
                        return d[0].x * mapScale, d[1].x * mapScale;
                    });
                    //Death Locations
                    d3.csv("deaths_age_sex.csv", function (deathLocations) {

                        //console.log(deathLocations)
                        //Create circles
                        svgContainer.selectAll("circle")
                            .data(deathLocations)
                            .attr("cx", function (d, i) {
                                if (1 == 1) {
                                    return mapScale * (d.x) - xMargin
                                } else {
                                    return null
                                }
                                ;
                            })
                            .attr("cy", function (d, i) {
                                if (1 == 1) {
                                    return yScale - mapScale * (d.y) + margin.top
                                } else {
                                    return null
                                }
                                ;
                            })
                            .attr("r", 1.5)
                            .attr("fill", function (d) {
                                if (d3.select('input[name="mode"]:checked').property("id") == 'Age') {
                                    if (d.age == 0) {
                                        return "#542788"
                                    }
                                    if (d.age == 1) {
                                        return "#998ec3"
                                    }
                                    if (d.age == 2) {
                                        return "#d8daeb"
                                    }
                                    if (d.age == 3) {
                                        return "#fee0b6"
                                    }
                                    if (d.age == 4) {
                                        return "#f1a340"
                                    }
                                    if (d.age == 5) {
                                        return "#b35806"
                                    } else {
                                        return "#c57a1a"
                                    }
                                } else {
                                    if (d.gender == 1) {
                                        return "#415ec5"
                                    } else {
                                        return "#c57a1a"
                                    }
                                    ;
                                }
                                ;
                            });

                    });
                });


            }
            });

        svgScatterPlot.selectAll("text")  // <-- Note "text", not "circle" or "rect"
            .data(deathsByAgeData)
            .enter()
            .append("text")     // <-- Same here!
            .attr("x", function(d) {
                return xScale(d.CensusPct)+margin.left+25+10
                    ;
            })
            .attr("y", function(d) {
                return yScale(d.Percent)-margin.bottom+17
                    ;
            })
            .attr("font-family", "sans-serif")
            .attr("font-size", "10px")
            .attr("fill", "black")
            .text(function(d) {
                return d.AgeGroup;
            });

        var g = d3.select('svgScatterPlot').select('g');



        var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom")
            .tickFormat(formatPercent);

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left")
            .ticks(10)
            .tickFormat(formatPercent);



        svgScatterPlot.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(" + (margin.left+25) +"," +(ScatterHeight-margin.bottom) + ")")
            .call(xAxis)
            .selectAll("text")
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(45)")
            .style("text-anchor", "start");

        svgScatterPlot.append('g')
            .attr('class', 'yaxis')
            .attr("transform", "translate(" + (margin.left+25) +", -15  )")
            .call(yAxis)
            .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("y", -30)
            .attr("x", -100)
            .style("text-anchor", "end")
            .style("font-size", "10px")
            .text("% of Total Cholera Deaths");

        svgScatterPlot.append('text')
            .attr("class","text")
            .attr("x", 250)
            .attr("y", 297)
            .attr("text-anchor", "middle")
            .style("font-size", "10px")
            .style("font-family", "sans-serif")
            .text("Census % of Total Population");


        svgScatterPlot.append('text')
            .attr("class","text")
            .attr("x", 250)
            .attr("y", 15)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-family", "sans-serif")
            .text("Deaths vs Census - Percent of Population by Age Group");

    })



    svgContainer.on({
        "mouseover": function(d) {
            d3.select(this).style("cursor", "pointer");
        },
        "mouseout": function(d) {
            d3.select(this).style("cursor", "default");
        }
    });

    svgBar.on({
        "mouseover": function(d) {
            d3.select(this).style("cursor", "pointer");
        },
        "mouseout": function(d) {
            d3.select(this).style("cursor", "default");
        }
    });

    svgScatterPlot.on({
        "mouseover": function(d) {
            d3.select(this).style("cursor", "pointer");
        },
        "mouseout": function(d) {
            d3.select(this).style("cursor", "default");
        }
    });

    svgDonut.on({
        "mouseover": function(d) {
            d3.select(this).style("cursor", "pointer");
        },
        "mouseout": function(d) {
            d3.select(this).style("cursor", "default");
        }
    });



</script>

</body>
</html>